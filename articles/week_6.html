<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="datascience.curriculum">
<title>Week 6:  Packages • datascience.curriculum</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Week 6:  Packages">
<meta property="og:description" content="datascience.curriculum">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">datascience.curriculum</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/week_1.html">Week 1:  Setting Up</a>
    <a class="dropdown-item" href="../articles/week_2.html">Week 2:  R Fundamentals</a>
    <a class="dropdown-item" href="../articles/week_3.html">Week 3:  Next Level R</a>
    <a class="dropdown-item" href="../articles/week_6.html">Week 6:  Packages</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Week 6:  Packages</h1>
            
      
      
      <div class="d-none name"><code>week_6.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This lecture is on building R data packages. This is a relatively
advanced topic, but I think it is important and can be learned quickly.
This lecture assumes you have a good working knowledge of R and your
computer file system. You do not need to be an expert in R to do
this.</p>
<p>Why would you want to build a data package? Here are the stages your
data will pass through:</p>
<ul>
<li>raw data: should be unchanged after creation. Can be entirely
contained within an R data package if it is a lightweight text file.
Larger files should be archived on a shared network drive.</li>
<li>processed data: these are data that have been processed into a form
that can be used for plotting or statistical analysis with only a few
lines of code and a second or two of computation time.</li>
<li>analyzed data: the final tables or figures that convey the results
of your experiment to your reader.</li>
</ul>
<p>The data package is meant to hold processed data and the code you
used to generate it from the raw data. Since these two things are
related, it is natural to keep them together in the same digital file.
Often data processing is computer resource or time-intensive and so you
don’t want to repeat it every time you interact with your work. Some
analyses (like single cell RNAseq dimension reduction) are not
absolutely reproducible in the strictest sense and so saving a processed
data object means you are always starting from the same place with your
subsequent analysis.</p>
<p>What should and shouldn’t be in a data package? This you will have to
decide for yourself. There is some overhead (effort) to making a data
package, so you won’t want to save things that can be very rapidly
calculated or derived from other data objects. Generally you want a data
package to be no more than a few GB in size so you may need to be
selective with what you save. If it takes more than 3-4 seconds to
calculate data for a table or figure, then I will usually put it in the
data package. Here are the types of things I do and don’t include</p>
<p>Do include:</p>
<ul>
<li>processed tabular data for generating statistics or plots</li>
<li>single cell data objects (e.g. cellDataSet or Seurat objects)</li>
<li>qc files for single cell analysis</li>
<li>genomic ranges objects</li>
</ul>
<p>Do not include:</p>
<ul>
<li>raw sequencing data, genomic features files, or cell-barcode
matrices</li>
<li>subsets of any object already in the data package</li>
<li>plots</li>
</ul>
<p>In summary, the benefits of using a data package are:</p>
<ul>
<li>Your processed data is linked to the code used to generate it</li>
<li>All processed data and code are in a single file that can be
distributed and used by collaborators or reviewers</li>
<li>Data objects are documented so you have a better chance of recalling
what they are and how they were generated at any point in the
future</li>
<li>Data objects are version-controlled and not easy to change
inadvertently.</li>
</ul>
</div>
<div class="section level2">
<h2 id="saving-r-objects">Saving R objects<a class="anchor" aria-label="anchor" href="#saving-r-objects"></a>
</h2>
<p>Once you have identified a data object you would like to put into a
package, you first need to save it to disk as a <code>.rda</code> file.
Usually you are going to be starting from within an analysis project.
Here are some rules/best practices:</p>
<ul>
<li>create a new directory called “data” to hold your data object</li>
<li>save only 1 object per file. R will let you save more but this is
not a desirable way to go.</li>
<li>give the file the same name as the object.</li>
<li>use compression to make the file size as small as possible</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># some demo data to save</span></span>
<span><span class="va">demo_iris_data</span> <span class="op">&lt;-</span> <span class="va">iris</span></span>
<span></span>
<span><span class="co"># make a data directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save the data as a .rda file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">demo_iris_data</span>, </span>
<span>     file <span class="op">=</span> <span class="st">"data/demo_iris_data.rda"</span>, </span>
<span>     compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre></div>
<p>The bzip2 compression algorithm is usually the most efficient.
Sometimes gzip may produce smaller files.</p>
<p>At this point you could just stop and then read in the data later
when needed using <code>load("data/demo_iris_data.rda")</code>. But it
is better to put this into a package and then install the package in
your project for the reasons mentioned above.</p>
</div>
<div class="section level2">
<h2 id="setting-up-the-package">Setting up the package<a class="anchor" aria-label="anchor" href="#setting-up-the-package"></a>
</h2>
<p>First you might want to update your R</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span></span>
<span>  usethis.full_name <span class="op">=</span> <span class="st">"Jane Doe"</span>,</span>
<span>  usethis.protocol  <span class="op">=</span> <span class="st">"ssh"</span>,</span>
<span>  usethis.description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Authors@R"</span> <span class="op">=</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/person.html" class="external-link">person</a></span><span class="op">(</span></span>
<span>        <span class="st">"Jane"</span>, <span class="st">"Doe"</span>,</span>
<span>        email <span class="op">=</span> <span class="st">"jane@example.com"</span>,</span>
<span>        role <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"aut"</span>, <span class="st">"cre"</span><span class="op">)</span>,</span>
<span>        comment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>ORCID <span class="op">=</span> <span class="st">"JANE'S-ORCID-ID"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    Version <span class="op">=</span> <span class="st">"0.0.0.9000"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  usethis.destdir <span class="op">=</span> <span class="st">"~/the/place/where/I/keep/my/R/projects"</span>,</span>
<span>  usethis.overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>I have the following lines saved in a script that I use whenever I
make a new data package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create the package and make it the active project </span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">create_package</span><span class="op">(</span><span class="st">"datascience.demopkg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make a license file</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_mit_license</span><span class="op">(</span><span class="st">"Brad Blaser"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make a readme file.  Use this to explain how to install and use your data package.</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_readme_md</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make a news file.  Use this to make notes on changes between versions of your data package.</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_news_md</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># initialize git and github (recommended)</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_git</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_github</span><span class="op">(</span>private <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>These commands will set up a very specific file and folder structure
in your project.</p>
<div class="figure">
<img src="images/package_structure.png" style="width:100.0%" alt=""><p class="caption">Package structure</p>
</div>
<p>Some important things to note</p>
<ul>
<li>DESCRIPTION: This is the file that indicates to R that this is a
package. The most important line for you to interact with is version.
Every time you make a new version of the package (add, delete or edit
data), you should increment the version number. Title and description
can be edited to provide a general description of the purpose of the
package but these are not critical. You should leave the other lines
as-is.</li>
<li>R/: This directory should contain R files. If you were building a
package with functions, this is where they would go. For a data-only
package, you will create a single R file here called “data.R”.</li>
<li>NAMESPACE: This is not used by data-only packages. Do not edit.</li>
<li>README.md and NEWS.md are text files you can edit as described
above.</li>
<li>The other files mostly boilerplate configuration files which should
be left alone.</li>
</ul>
</div>
<div class="section level2">
<h2 id="adding-data">Adding data<a class="anchor" aria-label="anchor" href="#adding-data"></a>
</h2>
<p>This is very simple. Just move the data directory from the analysis
project into the root directory of the new data package. If you are
editing an existing package, just copy the new .rda files. You can only
have 1 data directory.</p>
<div class="figure">
<img src="images/data_directory.png" style="width:100.0%" alt=""><p class="caption">Data directory added</p>
</div>
</div>
<div class="section level2">
<h2 id="adding-data-processing-code">Adding data-processing code<a class="anchor" aria-label="anchor" href="#adding-data-processing-code"></a>
</h2>
<p>It is good to keep the processed data with the code you used to
process it. That way if there is a problem you can track it down easily.
This code should go in a new directory called “data-raw”. This is an
unfortunate name because there is no data in there, only code.</p>
<p>You need to enclose this in a directory called “inst”. Everything in
the inst directory gets installed with your package.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"inst"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"inst/data-raw"</span><span class="op">)</span></span>
<span><span class="co"># now move the data processing scripts into data-raw</span></span></code></pre></div>
<div class="section level3">
<h3 id="option-include-raw-data">Option: include raw data<a class="anchor" aria-label="anchor" href="#option-include-raw-data"></a>
</h3>
<p>If you want to actually include the raw data or other files with your
package, make a directory called “inst/extdata” and put them in
there.</p>
</div>
</div>
<div class="section level2">
<h2 id="documenting-data">Documenting data<a class="anchor" aria-label="anchor" href="#documenting-data"></a>
</h2>
<p>Documenting your data is useful to yourself and others.</p>
<p>All objects in your data folder need to have a documentation entry.
Documentation is done in a structured text language called Roxygen which
is very easy to work with.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make a data.R file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.create</a></span><span class="op">(</span><span class="st">"R/data.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make sure the "sinew" package is installed and attached</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/yonicd/sinew" class="external-link">"sinew"</a></span><span class="op">)</span></span></code></pre></div>
<p>This will give you an “Addin” to Rstudio.</p>
<div class="figure">
<img src="images/sinew.png" style="width:100.0%" alt=""><p class="caption">Sinew addin</p>
</div>
<p>The best way to go from here is to</p>
<ul>
<li>load all of your new data objects into the global environment. In
this case there is only 1.</li>
<li>type the name in your data.R script</li>
<li>highlight the entire name of the object</li>
<li>click Addins &gt; createOxygen</li>
<li>you should get this:</li>
</ul>
</div>
<div class="section level2">
<h2 id="finish-up-the-data-package">Finish up the data package<a class="anchor" aria-label="anchor" href="#finish-up-the-data-package"></a>
</h2>
<p>Now you need to tell R to generate the documentation files and build
the binary data package.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate the formatted documentation manuals</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">document</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># optionally you can now commit and push to github using the terminal</span></span>
<span></span>
<span><span class="co"># build the binary data package</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">build</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>That’s it. When you run the last command, a .tar.gz file will be
generated in the directory enclosing your data package code. You can
move that wherever you like. Better yet you can provide a file path
where R will save the binary package. I usually save to network storage.
You want to be sure to increment your version number each time you make
changes so you don’t overwrite old versions of your data. It is always
good to be able to go back in time if needed.</p>
<p>The package can easily be shared inside your firewall with local
collaborators. For external collaborators or reviewers, OSU provides
access to the <a href="https://datadryad.org/stash/" class="external-link">Dryad</a> data
repository. There is a very straightforward web interface and the option
to keep data private until the manuscript is published.</p>
</div>
<div class="section level2">
<h2 id="installing-the-data-package">Installing the Data Package<a class="anchor" aria-label="anchor" href="#installing-the-data-package"></a>
</h2>
<p>The packages we make may be a little different from typical R
packages. They have no functions which is somewhat unusual but the
biggest difference is size. If you are working with single cell data, it
is likely that the size of your data package will exceed what R can
handle with its normal mechanisms for loading data.</p>
<p>Instead we use functions from a couple of packages to load the data
into your R session as a digital “pointer”. Until you ask R to reference
a particular data item, it will reside in memory as a tiny digital
address to an area on your hard drive. When you ask R to reference those
data with you code, it is then loaded into memory to be used. This has
the additional advantage of reducing memory requirements for your
work.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the packages we need</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"blaseRtools"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"lazyData"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># install the data package</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">bb_renv_datapkg</span>(<span class="sc">&lt;</span>path to directory containing data package<span class="sc">&gt;</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">requireData</span>(<span class="sc">&lt;</span>name of the data package without version number<span class="sc">&gt;</span>)</span></code></pre></div>
<p>The bb_renv_datapkg function will go to the directory where your data
lives, check for the latest version, and install it if necessary. This
is the recommended way to go because you almost always want the latest
version and you don’t want to waste time installing it if necessary. You
can also install it with <code>renv::install()</code> though.</p>
<p>The requireData command is what loads the digital pointers into your
R session. Check out the environment dropdown menu to see for
yourself.</p>
</div>
<div class="section level2">
<h2 id="exercises">Exercises<a class="anchor" aria-label="anchor" href="#exercises"></a>
</h2>
<p>By now you should be comfortable setting up an R project, analyzing
your data and making figures for a manuscript or presentation.</p>
<ul>
<li>Make an R data package with your own processed experimental data and
the processing code you used</li>
<li>Save it to a network (archival) drive</li>
<li>Load the data package back into your project using
<code>bb_renv_datapkg()</code> and <code>requireData()</code>.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Brad Blaser.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
